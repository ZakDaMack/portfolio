"use strict";(self.webpackChunkportfolio=self.webpackChunkportfolio||[]).push([[538],{1967:function(e,t,n){n.r(t),n.d(t,{Head:function(){return g},default:function(){return p}});var a=n(8453),r=n(6540);function o(e){const t=Object.assign({p:"p",em:"em",a:"a",pre:"pre",code:"code",strong:"strong",span:"span"},(0,a.RP)(),e.components);return r.createElement(r.Fragment,null,r.createElement(t.p,null,r.createElement(t.em,null,"We can use reverse proxies such as ",r.createElement(t.a,{href:"https://traefik.io/"},"Traefik")," to protect ourselves from public traffic accessing unwanted parts of our server, increasing security, performance, and reliability.  But how can we ensure that our incoming traffic isn't malicious?")),"\n",r.createElement(t.p,null,r.createElement(t.a,{href:"https://www.crowdsec.net/"},"CrowdSec"),'  is a free, modern & collaborative behavior detection engine, offering more features than Fail2Ban, which protects against brute-force attempts. Crowdsec utilizes multiple open source data sources shared amongst its many users to protect against common IPs and CVEs (Common Vulnerability Exploits) and acts as a "bouncer" for common reverse proxies such as Traefik and Nginx, even Authlog to protect you against unwanted SSH attempts.'),"\n",r.createElement(t.p,null,"In this guide, I will be adding Crowdsec to my existing Traefik reverse proxy to parse incoming traffic before being redirected by my reverse proxy."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-yaml"},'version: "3"\nservices:\n  # existing Traefik container\n  traefik:\n    image: traefik:v2.9\n    container_name: traefik\n    restart: unless-stopped\n    ports:\n      - 80:80\n      - 443:443\n    volumes:\n      - /etc/acme:/etc/acme\n      - /var/run/docker.sock:/var/run/docker.sock:ro\n      - /etc/traefik:/etc/traefik\n      - /var/log:/var/log\n    labels:\n      # these are the min traefik settings required to get crowdsec working\n      # crowdsec parses the access log to look for any offending IPs\n      - accessLog=true\n      - accessLog.filePath=/var/log/traefik/access.log\n      - accessLog.bufferingSize=100 \n      - accessLog.filters.statusCodes=204-299,400-499,500-59 \n      - providers.docker=true\n      - entrypoints.web.address=:80acme.json\n      - entrypoints.http.http.middlewares=bouncer@docker\n  \n  # the actual crowdsec application\n  crowdsec:\n    image: crowdsecurity/crowdsec:latest\n    container_name: crowdsec\n    restart: unless-stopped\n    depends_on:\n      - traefik\n    volumes:\n      - /etc/crowdsec:/etc/crowdsec\n      - /var/lib/crowdsec/data:/var/lib/crowdsec/data\n      - /var/log:/var/log\n    environment:\n      COLLECTIONS: crowdsecurity/linux crowdsecurity/traefik\n  \n  # the bouncer which is polled by traefik\n  bouncer:\n    image: fbonalair/traefik-crowdsec-bouncer:latest\n    container_name: bouncer\n    restart: unless-stopped\n    environment:\n      CROWDSEC_BOUNCER_API_KEY: \n      CROWDSEC_AGENT_HOST: crowdsec:8080\n    depends_on:\n      - crowdsec\n    # the labels tell traefik to make a middleware which calls the bouncer before routing to ensure that the traffic is genuine\n    labels:\n      - traefik.http.middlewares.bouncer.forwardauth.address=http://bouncer:8080/api/v1/forwardAuth\n      - traefik.http.middlewares.bouncer.forwardauth.trustForwardHeader=true\n      - traefik.http.services.bouncer.loadbalancer.server.port=8080\n')),"\n",r.createElement(t.p,null,"Above is a basic ",r.createElement(t.em,null,"docker-compose.yaml")," file which contains the  3 docker images needed to set up crowdsec. The main crowdsec container does all the legwork and contains the decisions list and apis to poll the public blocklists and decide if an incoming IP is valid or not. The bouncer container is the middleware that traefik uses to communicate with crowdsec, all incoming traffic will go through the bouncer before being forwarded to the correct internal server."),"\n",r.createElement(t.p,null,"Once the containers are up and running, we need  to connect the crowdsec container to the crowdsec API. To do this, you will need to navigate to ",r.createElement(t.a,{href:"https://www.crowdsec.net/?ref=blog.zakdowsett.co.uk"},"CrowdSec")," and create a free account. Then go to ",r.createElement(t.strong,null,"Security Engines")," under your profile and create a new engine. This will generate a token for you to easily register your crowdec container to their API:"),"\n",r.createElement(t.p,null,r.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/f3f5b8362b8fe9d9252b2d5a15ed5196/9239a/enrollengine.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 63.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABi0lEQVR42q2S3W6CQBSEeYMK/gAqKKiAggL+o1RtY629apqYXjZp3/8dpucs1aTRWm168QU2zBlmdley/BRetEaru0Tdn6IVpnDjJbFAozsXOOEtau0JTG98kt3Wx8ezg+EohhQMEkTTDYLxBv35FvHsEfXOFBaZ8/MS7CBBI5jRTALp/bWN9WYJnwzvnnZIH15QdYY/pjmFR4384T2ZziHpdkw1uV5Kf0tg+zMYJCrUuihZ4VUUjACSyoa9hTB1ohXcaClqqHZ0NfmqT4bkbLojVFuDAwZVLtV7KJgBipT0N1irkaHChhxTM9tQqy5KJn2kdZFQScjImovcGfi7UvZI24NS6ZAhm9QzVDsEJ9asCLqdpcwShEepeO8rzQH0RowywU9RuUIVm70UTbpvhjOC3gxheSuE8Rtdg4m4CpbXp5NciNPP6R7kcltQolQ8w4YFo4s8JyzSPmlWLCLLJBYDhFLuHAZlqqRUsvfcl2bPXrNfS7zg7jIZfBe7R8OXIO1fbv4wfNbwv/gELx9wG/zSOqcAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="Enroll on CrowdSec website"\n        title=""\n        src="/static/f3f5b8362b8fe9d9252b2d5a15ed5196/c1b63/enrollengine.png"\n        srcset="/static/f3f5b8362b8fe9d9252b2d5a15ed5196/5a46d/enrollengine.png 300w,\n/static/f3f5b8362b8fe9d9252b2d5a15ed5196/0a47e/enrollengine.png 600w,\n/static/f3f5b8362b8fe9d9252b2d5a15ed5196/c1b63/enrollengine.png 1200w,\n/static/f3f5b8362b8fe9d9252b2d5a15ed5196/9239a/enrollengine.png 1246w"\n        sizes="(max-width: 1200px) 100vw, 1200px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",r.createElement(t.em,null,"Get your new security engine token from the CrowdSec website")),"\n",r.createElement(t.p,null,"The code can then be executed on the docker container like so:"),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-bash"},"sudo docker exec crowdsec cscli console enroll {your token value here}\n")),"\n",r.createElement(t.p,null,"Once that is done, go back to the CrowdSec website and confirm that you want to enroll the engine, and voila! Just like that, your CrowdSec engine is authenticated and can call the CrowdSec API. You can also view your statistics and alerts on the website at any time to see how many threats you have prevented."),"\n",r.createElement(t.p,null,r.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/c2e4cb1922fddd88043d83a28a2e62e6/e9140/acceptenroll.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 42.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABZklEQVR42n2Ry1LCQBBF8w1igPBIQkjI+20CIQGCaIGlJeVC3Vnl1p1rP/7aM8ACBBenenpq5vbtbsGO72FGKwz9kmMnNex0CTOeQw8qjKIZMYdij8+iEi9rH1+vBupZCCHIanjZGl6+QlI9cBHZyo8/OZN/ke0CijMlCggf7zmC6RbF8gnPb5/krkbfzC46OoUVt5IFfDJkhBWErhGjpUVoqgGu+i7adGa5qPhoDsI/tC7B/wQQLJpZUm04UblGOtvAYS6tDJIeEwk6hLSHFz9TqKmFaPQ9CLKd09zYQqbQvIKfmXUWB5SzGSkOm+MYA7dAx0ghUjftYUwiB/GI05CZoFWgZ+Z8GezDwQlrXaMiVryA6k64EHPKYo9m7I/v4NwsKSfXQ58IdoKSnvLW2MPuKOWVJYJHEugyIWN3f0xC282o4C3qxQ/K8ptadiGIqs8XcL1HPOHS/WFpHSOD4Wyh249c8Bfa3wx2NOay9AAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="Confirm engine enrollment"\n        title=""\n        src="/static/c2e4cb1922fddd88043d83a28a2e62e6/c1b63/acceptenroll.png"\n        srcset="/static/c2e4cb1922fddd88043d83a28a2e62e6/5a46d/acceptenroll.png 300w,\n/static/c2e4cb1922fddd88043d83a28a2e62e6/0a47e/acceptenroll.png 600w,\n/static/c2e4cb1922fddd88043d83a28a2e62e6/c1b63/acceptenroll.png 1200w,\n/static/c2e4cb1922fddd88043d83a28a2e62e6/e9140/acceptenroll.png 1226w"\n        sizes="(max-width: 1200px) 100vw, 1200px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",r.createElement(t.em,null,"Confirm that you want to enroll your container with CrowdSec")),"\n",r.createElement(t.p,null,"Now, we need to connect our bouncer to CrowdSec so that our reverse proxy can query the CrowdSec API. To do that, we need to generate a key to ensure that only the bouncer can query our CrowdSec container:"),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-bash"},"sudo docker exec crowdsec cscli bouncers add traefik-bouncer\n")),"\n",r.createElement(t.p,null,"Copy the key that is returned and add it into the environment variable ",r.createElement(t.em,null,"CROWDSEC_BOUNCER_API_KEY")," that we left blank before in our compose file. Once this is done, restart your containers and everything is ready to go!"),"\n",r.createElement(t.p,null,r.createElement(t.strong,null,"Now lets test to see if everything works:")),"\n",r.createElement(t.p,null,"To make sure everything works, we will add our public IP to our decisions list to ensure that any traffic from our address is blocked by Crowdsec, like so:"),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-bash"},"sudo docker exec crowdsec cscli decisions add --ip XXX.XX.XX.XXX\n")),"\n",r.createElement(t.p,null,"Then, navigating to one of our endpoints, it should return a 403 (Forbidden response) like so:"),"\n",r.createElement(t.p,null,r.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 545px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/eff93ed4416202f6cb8101692a0c2ffb/3ddad/forbidden.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 29.666666666666668%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABBElEQVR42qXMS0sCYQCF4fkPEpRzc+b7xhkdzds4Zt7CLhaYRQmR0iK6aUQRtAkqFxFE0G9+G6ygiFYuHl7O5ihr4pZV64GWuKHjT9gL39kpvdHNv9KWE1bsJ1rWI+vJZ4raADHXwIrV/7BjjSmln79jI/lC271nWV5TdcYsyQtC+5wgcUbJPJ2qOlcU7CFpo0fqm/5ZT9/G1bpTSlHu42k90vouBXFATvRJmz2k2iGpb0U28cwuQfaISu6YWmlEszymFV7SjNSDEZXFEzLikKwcoPhumVymhicDDNXH1DL/8DG+mD/pv7fiOCk8N4sQLvG4iaomZqLommBhPjqKW2iqPbMP5He4L2hdqPQAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="Website with 503 message"\n        title=""\n        src="/static/eff93ed4416202f6cb8101692a0c2ffb/3ddad/forbidden.png"\n        srcset="/static/eff93ed4416202f6cb8101692a0c2ffb/5a46d/forbidden.png 300w,\n/static/eff93ed4416202f6cb8101692a0c2ffb/3ddad/forbidden.png 545w"\n        sizes="(max-width: 545px) 100vw, 545px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",r.createElement(t.em,null,"Your website should now show a forbidden message")),"\n",r.createElement(t.p,null,"Once we're happy that everything is set up and working, we can remove our IP from the decisions list so that we can access everything again:"),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-bash"},"sudo docker exec crowdsec cscli decisions delete --ip XXX.XX.XX.XXX\n")),"\n",r.createElement(t.p,null,r.createElement(t.strong,null,"A quick note:")),"\n",r.createElement(t.p,null,"If you are using Traefik, you may find that Crowdsec is not listening for offending IPs in your access log. If this is the case, you will need to modify your ",r.createElement(t.em,null,"acquis.yaml")," file, found under /etc/crowdsec and append the follwoing lines  to the bottom of the yaml so that CrowdSec knows where your Traefik access log is:"),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-yaml"},"---\nfilenames:\n  - /var/log/traefik/access.log\nlabels:\n  type: traefik\n")))}var l=function(e){void 0===e&&(e={});const{wrapper:t}=Object.assign({},(0,a.RP)(),e.components);return t?r.createElement(t,e,r.createElement(o,e)):o(e)},c=n(9404),s=n(4194),i=n(2532),d=n(1183),m=n(1629);const u=e=>{var t,n,o,l,u,p,g,f,b,h;let{data:w,children:y}=e;const v=w.mdx,A=(0,i.c)(v.frontmatter.hero_img);return r.createElement(r.Fragment,null,r.createElement(d.A,{className:"max-w-screen-xl left-1/2 -translate-x-1/2",blurHeight:100}),r.createElement("main",{className:"w-screen min-h-screen"},r.createElement("article",null,r.createElement(c.P.section,{initial:{opacity:0,y:50},whileInView:{opacity:1,y:0},viewport:{once:!0},className:"mx-auto pt-3 px-4 max-w-screen-xl"},r.createElement("div",{className:"rounded-3xl overflow-hidden relative"},r.createElement(i.G,{image:A,objectFit:"cover",className:"w-full aspect-video",alt:null==v||null===(t=v.frontmatter)||void 0===t?void 0:t.hero_attr}),r.createElement("div",{className:"absolute top-0 bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent hidden md:flex flex-col justify-end p-6  "},r.createElement("div",null,null==v||null===(n=v.frontmatter)||void 0===n||null===(o=n.tags)||void 0===o?void 0:o.map(e=>r.createElement(s.Link,{key:e,className:"rounded-3xl p-3 bg-black/10 text-nord-4 border border-nord-0 backdrop-blur-sm",to:`/tags/${e.toLowerCase()}`},e))),r.createElement("div",{className:"md:flex justify-between items-end my-8"},r.createElement("div",{className:"space-y-3 max-w-4xl"},r.createElement("h1",{className:"text-3xl md:text-5xl text-nord-6 font-bold"},null==v||null===(l=v.frontmatter)||void 0===l?void 0:l.title),r.createElement("p",{className:"text-lg text-neutral-400"},null==v||null===(u=v.frontmatter)||void 0===u?void 0:u.subtitle)),r.createElement("div",null,r.createElement("p",{className:"text-nord-6"},null==v||null===(p=v.frontmatter)||void 0===p?void 0:p.date))))),r.createElement("p",{className:"text-sm pl-4"},null==v||null===(g=v.frontmatter)||void 0===g?void 0:g.hero_attr)),r.createElement(c.P.section,{initial:{opacity:0,y:50},whileInView:{opacity:1,y:0},viewport:{once:!0},transition:{delay:.2},id:"article__content",className:"text-justify space-y-6 px-4 md:px-8 pt-6 pb-16 md:py-28 max-w-screen-md mx-auto"},r.createElement("div",{className:"block md:hidden mb-8 text-left"},r.createElement("div",{className:"space-y-3"},r.createElement("h1",{className:"text-2xl font-bold"},null==v||null===(f=v.frontmatter)||void 0===f?void 0:f.title),r.createElement("p",{className:"text-lg text-neutral-400"},null==v||null===(b=v.frontmatter)||void 0===b?void 0:b.subtitle)),r.createElement("p",null,null==v||null===(h=v.frontmatter)||void 0===h?void 0:h.date),r.createElement("div",{className:"border mt-6"})),r.createElement(a.xA,null,y)))),r.createElement(m.A))};function p(e){return r.createElement(u,e,r.createElement(l,e))}const g=e=>{var t,n;let{data:a}=e;return r.createElement("title",null,null===(t=a.mdx)||void 0===t||null===(n=t.frontmatter)||void 0===n?void 0:n.title," | Zak Dowsett")}},8453:function(e,t,n){n.d(t,{RP:function(){return o},xA:function(){return c}});var a=n(6540);const r=a.createContext({});function o(e){const t=a.useContext(r);return a.useMemo(()=>"function"==typeof e?e(t):{...t,...e},[t,e])}const l={};function c({components:e,children:t,disableParentContext:n}){let c;return c=n?"function"==typeof e?e({}):e||l:o(e),a.createElement(r.Provider,{value:c},t)}}}]);
//# sourceMappingURL=component---src-templates-blog-jsx-content-file-path-blog-2024-03-13-strengthen-network-security-index-mdx-51e679a42496dd96e995.js.map